{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "![](https://globaleventcdn.blob.core.windows.net/assets/ops/ops20/screenshots/TailwindLogo.JPG) \r\n## Troubleshooting Guide\r\n\r\nThis troubleshooting guide provides you with shortcuts to helpful tools during remediation efforts.\r\n\r\n---\r\n\r\n"
      },
      "name": "text - 11"
    },
    {
      "type": 11,
      "content": {
        "version": "LinkItem/1.0",
        "style": "nav",
        "links": [
          {
            "cellValue": "https://portal.azure.com/?feature.customportal=false#@microsoft.onmicrosoft.com/dashboard/arm/subscriptions/cd400f31-6f94-40ab-863a-673192a3c0d0/resourcegroups/ops20jhand0102/providers/microsoft.portal/dashboards/641d6c4f-9724-405c-8159-5ce42c30eac8-dashboard",
            "linkTarget": "Url",
            "linkLabel": "Master Dashboard",
            "style": "link"
          },
          {
            "cellValue": "https://dev.azure.com/icm-poc/Serverless%20Incident%20Management/_workitems/recentlyupdated/",
            "linkTarget": "Url",
            "linkLabel": "Incident Dashboard",
            "preText": "",
            "style": "link"
          },
          {
            "cellValue": "https://teams.microsoft.com/l/channel/@{body('Create_a_channel')?['id']}/Active%2520Incident%2520@{body('Create_a_work_item')?['id']}?groupId=042fcb78-dd7d-4300-84c2-1515890c1697&tenantId=72f988bf-86f1-41af-91ab-2d7cd011db47",
            "linkTarget": "Url",
            "linkLabel": "Incident Chat",
            "style": "link"
          },
          {
            "cellValue": "https://tailwindstatus.z22.web.core.windows.net/",
            "linkTarget": "Url",
            "linkLabel": "Status Page",
            "style": "link"
          },
          {
            "cellValue": "https://docs.microsoft.com/en-us/azure/kusto/query/",
            "linkTarget": "Url",
            "linkLabel": "KQL Reference",
            "style": "link"
          },
          {
            "cellValue": "https://shell.azure.com",
            "linkTarget": "Url",
            "linkLabel": "Cloud Shell",
            "style": "link"
          }
        ]
      },
      "name": "links - 2"
    },
    {
      "type": 1,
      "content": {
        "json": "## Remediation\r\n\r\n- Create Incident Ticket (if one doesn't exist)\r\n- Update Status Page\r\n- Check Azure Service Health, Application Map, Log Analytics, and quick metrics/logs below\r\n\r\nSet the parameters below to tune your analysis set. Use the `Show` parameter above to see only existing or new failures. The comparision `UseComparisionTimeRange` parameter sets the window of time to look for existing failures. `Requests` and `ResultCodes` parameters allow you to filter down to a smaller set of issues."
      },
      "name": "text - 2"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "eac9cbf1-6364-4f28-9c61-a9b038c035d7",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "type": 4,
            "description": null,
            "isRequired": true,
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 300000,
                  "createdTime": "2018-06-04T19:27:14.510Z",
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 900000,
                  "createdTime": "2018-06-04T19:27:14.510Z",
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 1800000,
                  "createdTime": "2018-06-04T19:27:14.510Z",
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 3600000,
                  "createdTime": "2018-06-04T19:27:14.510Z",
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 14400000,
                  "createdTime": "2018-06-04T19:27:14.510Z",
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 43200000,
                  "createdTime": "2018-06-04T19:27:14.510Z",
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 86400000,
                  "createdTime": "2018-06-04T19:27:14.511Z",
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 172800000,
                  "createdTime": "2018-06-04T19:27:14.511Z",
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 259200000,
                  "createdTime": "2018-06-04T19:27:14.511Z",
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 604800000,
                  "createdTime": "2018-06-04T19:27:14.511Z",
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 1209600000,
                  "createdTime": "2018-06-04T19:27:14.511Z",
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                },
                {
                  "durationMs": 2419200000,
                  "createdTime": "2018-06-04T19:27:14.511Z",
                  "isInitialTime": false,
                  "grain": 1,
                  "useDashboardTimeRange": false
                }
              ],
              "allowCustom": false
            },
            "value": {
              "durationMs": 43200000
            }
          },
          {
            "id": "6ab5c1cb-bad0-4d96-8e63-d439d0681c6e",
            "version": "KqlParameterItem/1.0",
            "name": "Requests",
            "type": 2,
            "description": null,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "requests\n| where timestamp {TimeRange}\n| summarize Count = count(), Users = dcount(user_Id) by name\n| order by name asc\n| project v = name, t = name, s=false\n| union (datatable(v:string, t:string, s:boolean)[\n'*', 'All Requests', true\n])",
            "resourceType": "microsoft.insights/components"
          },
          {
            "id": "5e558db3-501c-4ce3-87c3-7f13a469fd54",
            "version": "KqlParameterItem/1.0",
            "name": "ResultCodes",
            "type": 2,
            "description": null,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "datatable(x:string, y:string, z:boolean)[\r\n'*', 'All', true,\r\n'@', 'All 500s', false,\r\n'#', 'All 400s', false\r\n]\r\n| union (requests\r\n| where timestamp {TimeRange}\r\n| where success == false\r\n| summarize by resultCode\r\n| order by resultCode asc\r\n| project x = resultCode, y = resultCode, z = false)",
            "resourceType": "microsoft.insights/components"
          },
          {
            "id": "84caf619-7585-48e0-a9c3-85c364aaa13b",
            "version": "KqlParameterItem/1.0",
            "name": "Show",
            "type": 2,
            "description": null,
            "isRequired": true,
            "query": "datatable(x:string, y:string)[\r\n\"['New Failure Rate (%)'], ['Existing Failure Rate (%)']\", 'New and Existing Failures',\r\n\"['New Failure Rate (%)']\", 'Only New Failures',\r\n\"['Existing Failure Rate (%)']\", 'Only Existing Failures',\r\n]",
            "value": "['New Failure Rate (%)'], ['Existing Failure Rate (%)']"
          },
          {
            "id": "6f0de137-0136-48f0-b463-640de7109c05",
            "version": "KqlParameterItem/1.0",
            "name": "UseComparisonTimeRangeOf",
            "type": 1,
            "description": null,
            "isRequired": true,
            "query": "let t = todatetime({TimeRange:end}) - todatetime({TimeRange:start});\r\nlet w = case(t <= 1d, '7d', t <= 3d, '14d', t <= 14d, '28d', '60d');\r\nrange i from 1 to 1 step 1\r\n| project x = w",
            "resourceType": "microsoft.insights/components",
            "value": "14d"
          }
        ],
        "style": "pills",
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "name": "parameters - 1"
    },
    {
      "type": 1,
      "content": {
        "json": "## Failure Trend\nThe chart below shows the trend of request failures over your chosen time range. It is split by new and existing failures. "
      },
      "name": "text - 3"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let bigWindow = requests\r\n| where timestamp >= {TimeRange:start} - {UseComparisonTimeRangeOf} and timestamp <= {TimeRange:start}\r\n| where success == false\r\n| where name in ({Requests}) or '*' in ({Requests})\r\n| where resultCode in ({ResultCodes}) or '*' in ({ResultCodes}) or iff('@' in ({ResultCodes}), resultCode startswith '5', false) or iff('#' in ({ResultCodes}), resultCode startswith '4', false)\r\n| summarize by name, resultCode\r\n| summarize makelist(strcat(name, '-', resultCode), 100000);\r\nlet data = requests\r\n| where timestamp {TimeRange}\r\n| where name in ({Requests}) or '*' in ({Requests})\r\n| where resultCode in ({ResultCodes}) or '*' in ({ResultCodes}) or iff('@' in ({ResultCodes}), resultCode startswith '5', false) or iff('#' in ({ResultCodes}), resultCode startswith '4', false)\r\n| where success == false;\r\ndata\r\n| extend IsNew = strcat(name, '-', resultCode) !in (bigWindow)\r\n| where \"{Show}\" == \"['New Failure Rate (%)'], ['Existing Failure Rate (%)']\" or IsNew == true\r\n//| summarize Count = count() by bin(timestamp, {TimeRange:grain}), ['Failure'] = iff(IsNew, 'New Failure', 'Existing Failure')\r\n| make-series Count = count()  default = 0 on timestamp in range({TimeRange:start}, now(), {TimeRange:grain}) by ['Failure'] = iff(IsNew, 'New Failure', 'Existing Failure')\r\n\r\n",
        "size": 0,
        "exportToExcelOptions": "visible",
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "barchart"
      },
      "name": "query - 4"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "// failed request count by name\nlet start=datetime(\"2019-09-18T20:46:00.000Z\");\nlet end=datetime(\"2019-09-18T22:22:00.000Z\");\nlet timeGrain=1m;\nlet dataset=requests\n// additional filters can be applied here\n| where timestamp > start and timestamp < end\n| where client_Type != \"Browser\" ;\n// calculate failed request count for all requests\ndataset\n| summarize failedCount=sumif(itemCount, success == false) by bin(timestamp, timeGrain)\n| extend request='Overall'\n// render result in a chart\n| render timechart",
        "size": 0,
        "timeContext": {
          "durationMs": 0
        },
        "timeContextFromParameter": "TimeRange",
        "exportToExcelOptions": "visible",
        "queryType": 0,
        "resourceType": "microsoft.insights/components"
      },
      "name": "query - 11"
    },
    {
      "type": 3,
      "content": {
        "version": "KqlItem/1.0",
        "query": "let bigWindow = requests\n| where timestamp >= {TimeRange:start} - {UseComparisonTimeRangeOf} and timestamp <= {TimeRange:start}\n| where success == false\n| where name in ({Requests}) or '*' in ({Requests})\n| where resultCode in ({ResultCodes}) or '*' in ({ResultCodes}) or iff('@' in ({ResultCodes}), resultCode startswith '5', false) or iff('#' in ({ResultCodes}), resultCode startswith '4', false)\n| summarize by name, resultCode\n| summarize makelist(strcat(name, '-', resultCode), 100000);\nlet data = requests\n| where timestamp {TimeRange}\n| where name in ({Requests}) or '*' in ({Requests})\n| where resultCode in ({ResultCodes}) or '*' in ({ResultCodes}) or iff('@' in ({ResultCodes}), resultCode startswith '5', false) or iff('#' in ({ResultCodes}), resultCode startswith '4', false)\n| where success == false;\ndata\n| summarize Count = count(), Users = dcount(user_Id) by name, resultCode\n| extend IsNew = strcat(name, '-', resultCode) !in (bigWindow)\n| where \"{Show}\" == \"['New Failure Rate (%)'], ['Existing Failure Rate (%)']\" or IsNew == true\n| join kind=inner (data\n    | make-series Trend = count() default = 0 on timestamp in range({TimeRange:start}, now(), {TimeRange:grain}) by name\n    | project name, Trend\n    ) on name\n| order by Users desc, Count desc, name asc\n| project ['Request Name'] = iff(IsNew, strcat('ðŸ”¸ ', name), strcat('ðŸ”¹ ', name)), ['Failed with Result Code'] = resultCode, ['Failures'] = Count, ['Users Affected'] = Users, ['Trend'] = Trend\n",
        "size": 0,
        "aggregation": 2,
        "exportToExcelOptions": "visible",
        "queryType": 0,
        "resourceType": "microsoft.insights/components",
        "visualization": "table",
        "gridSettings": {
          "formatters": [
            {
              "columnMatch": "Failures",
              "formatter": 4,
              "formatOptions": {
                "min": 0,
                "max": null,
                "palette": "blue"
              }
            },
            {
              "columnMatch": "Users Affected",
              "formatter": 4,
              "formatOptions": {
                "min": 0,
                "max": null,
                "palette": "blue"
              }
            },
            {
              "columnMatch": "Trend",
              "formatter": 9,
              "formatOptions": {
                "min": 0,
                "max": null,
                "palette": "greenRed"
              }
            }
          ]
        }
      },
      "name": "query - 7"
    },
    {
      "type": 1,
      "content": {
        "json": "## Failure Details"
      },
      "name": "text - 5"
    },
    {
      "type": 1,
      "content": {
        "json": "\nðŸ”¸ New Failure ðŸ”¹ Existing Failure"
      },
      "name": "text - 6"
    },
    {
      "type": 1,
      "content": {
        "json": "## Once the Incident has been resolved\n\n- [Close the ticket](https://dev.azure.com/icm-poc/Serverless%20Incident%20Management/_workitems/recentlyupdated/)\n- Update the status page (see instructions above - use `close` instead of `open`)\n- Collect evidence and data for the post-incident review\n- Schedule post-incident review. [Action Item](https://dev.azure.com)"
      },
      "name": "text - 9"
    }
  ],
  "styleSettings": {},
  "fromTemplateId": "community-Workbooks/TSG/Request Failures",
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}